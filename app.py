import streamlit as st
import google.generativeai as genai
import yt_dlp
import os
from moviepy.editor import VideoFileClip

# ржЖржкржирж╛рж░ ржжрзЗржУрзЯрж╛ API Key
genai.configure(api_key="AIzaSyCtSq9O0903w-GdJeQHHBqD2fTQ088QhCk")

st.set_page_config(page_title="AI Viral Clip Maker", page_icon="ЁЯФе")
st.title("ЁЯФе AI Viral Clip Maker (Hiclip Style)")
st.write("ржмрзЬ ржнрж┐ржбрж┐ржУ ржерзЗржХрзЗ рзз ржорж┐ржирж┐ржЯрзЗрж░ ржнрж╛ржЗрж░рж╛рж▓ ржХрзНрж▓рж┐ржк, ржЯрж╛ржЗржЯрзЗрж▓ ржУ ржлрж░рзНржорзБрж▓рж╛ рждрзИрж░рж┐ ржХрж░рзБржиред")

url = st.text_input("YouTube ржнрж┐ржбрж┐ржУрж░ рж▓рж┐ржЩрзНржХ ржжрж┐ржи:")

if st.button("ржнрж╛ржЗрж░рж╛рж▓ ржХрзНрж▓рж┐ржк ржУ ржлрж░рзНржорзБрж▓рж╛ рждрзИрж░рж┐ ржХрж░рзЛ"):
    if url:
        try:
            with st.spinner("AI ржнрж┐ржбрж┐ржУ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░ржЫрзЗ ржПржмржВ ржнрж╛ржЗрж░рж╛рж▓ ржХрзНрж▓рж┐ржк ржХрж╛ржЯржЫрзЗ..."):
                # рзз. ржЗржЙржЯрж┐ржЙржм ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб
                ydl_opts = {
                    'format': 'best[ext=mp4]',
                    'outtmpl': 'main_video.mp4',
                    'noplaylist': True,
                }
                with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                    ydl.download([url])
                
                # рзи. Gemini AI ржХрзЗ ржнрж┐ржбрж┐ржУ ржкрж╛ржарж╛ржирзЛ (ржмрж┐рж╢рзНрж▓рзЗрж╖ржгрзЗрж░ ржЬржирзНржп)
                video_file = genai.upload_file(path="main_video.mp4")
                model = genai.GenerativeModel("gemini-1.5-flash")
                
                # AI ржХрзЗ ржнрж╛ржЗрж░рж╛рж▓ ржлрж░рзНржорзБрж▓рж╛ ржУ рзз ржорж┐ржирж┐ржЯрзЗрж░ ржХржо ржХрзНрж▓рж┐ржк ржХрж╛ржЯрж╛рж░ ржирж┐рж░рзНржжрзЗрж╢
                prompt = """ржПржЗ ржнрж┐ржбрж┐ржУржЯрж┐ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг ржХрж░рзЛред рззржЯрж┐ рж╕ржмржЪрзЗрзЯрзЗ ржнрж╛ржЗрж░рж╛рж▓ рж╣ржУрзЯрж╛рж░ ржорждрзЛ ржЕржВрж╢ ржЦрзБржБржЬрзЗ ржмрзЗрж░ ржХрж░рзЛ ржпрж╛ рзз ржорж┐ржирж┐ржЯрзЗрж░ ржХржо (рзйрзж-рзмрзж рж╕рзЗржХрзЗржирзНржб)ред 
                ржЖржорж╛ржХрзЗ ржПржЗ ржлрж░ржорзНржпрж╛ржЯрзЗ ржЙрждрзНрждрж░ ржжрж╛ржУ:
                рзз. ржХрзНрж▓рж┐ржкрзЗрж░ рж╢рзБрж░рзБрж░ рж╕ржорзЯ ржПржмржВ рж╢рзЗрж╖рзЗрж░ рж╕ржорзЯ (ржпрзЗржоржи: 00:15 to 00:55)
                рзи. ржПржХржЯрж┐ ржнрж╛ржЗрж░рж╛рж▓ ржЯрж╛ржЗржЯрзЗрж▓ ржпрж╛ ржорж╛ржирзБрж╖ржХрзЗ ржХрзНрж▓рж┐ржХ ржХрж░рждрзЗ ржмрж╛ржзрзНржп ржХрж░ржмрзЗред
                рзй. ржнрж╛ржЗрж░рж╛рж▓ ржлрж░рзНржорзБрж▓рж╛: ржХрзЗржи ржПржЗ ржХрзНрж▓рж┐ржкржЯрж┐ ржнрж╛ржЗрж░рж╛рж▓ рж╣ржмрзЗ (рж╣рзБржХ ржмрж╛ ржЗржорзЛрж╢ржи ржХрж┐)ред"""
                
                response = model.generate_content([prompt, video_file])
                
                # рзй. ржнрж┐ржбрж┐ржУ ржХрзНрж▓рж┐ржк ржХрж╛ржЯрж╛ (MoviePy ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ)
                full_video = VideoFileClip("main_video.mp4")
                # ржкрзНрж░рж╛ржержорж┐ржХ ржкрж░рзАржХрзНрж╖рж╛рж░ ржЬржирзНржп ржкрзНрж░ржержо рзкрзл рж╕рзЗржХрзЗржирзНржб ржХрж╛ржЯрж╛ рж╣ржЪрзНржЫрзЗ (AI рж░рзЗржЬрж╛рж▓рзНржЯ ржерзЗржХрзЗ рж╕ржорзЯ ржирзЗржУрзЯрж╛ ржЖрж░ржУ ржЙржирзНржиржд ржХрж░рж╛ ржпрж╛рзЯ)
                clip_duration = min(45, full_video.duration)
                clip = full_video.subclip(0, clip_duration)
                clip.write_videofile("viral_short.mp4", codec="libx264", audio_codec="aac")
                
                # рзк. ржЖржЙржЯржкрзБржЯ ржкрзНрж░ржжрж░рзНрж╢ржи
                st.success("ржЖржкржирж╛рж░ ржнрж╛ржЗрж░рж╛рж▓ ржХрзНрж▓рж┐ржк рждрзИрж░рж┐ рж╣рзЯрзЗ ржЧрзЗржЫрзЗ!")
                
                st.subheader("ЁЯЪА ржнрж╛ржЗрж░рж╛рж▓ ржЯрж╛ржЗржЯрзЗрж▓ ржУ ржлрж░рзНржорзБрж▓рж╛ (AI Analysis):")
                st.info(response.text)
                
                st.subheader("ЁЯУ╜я╕П ржЖржкржирж╛рж░ ржнрж╛ржЗрж░рж╛рж▓ ржХрзНрж▓рж┐ржк (Max 60s):")
                st.video("viral_short.mp4")
                
                with open("viral_short.mp4", "rb") as f:
                    st.download_button("ржЧрзНржпрж╛рж▓рж╛рж░рж┐рждрзЗ рж╕рзЗржн ржХрж░рзБржи", f, file_name="viral_clip.mp4")
                
                full_video.close()
                # ржХрзНрж▓рж┐ржирж┐ржВ (ржкрзБрж░рж╛ржирзЛ ржлрж╛ржЗрж▓ ржорзБржЫрзЗ ржлрзЗрж▓рж╛)
                os.remove("main_video.mp4")

        except Exception as e:
            st.error(f"ржжрзБржГржЦрж┐ржд, ржХрзЛржирзЛ рж╕ржорж╕рзНржпрж╛ рж╣рзЯрзЗржЫрзЗ: {e}")
            
